PHASE 3A â€” PAYSTACK CORE INTEGRATION

MASTER PROMPT (STRICT Â· NO DEVIATIONS)

ROLE

You are acting as a Senior Payments Engineer implementing Phase 3A only of a production marketplace.
You are NOT allowed to add features, refactor unrelated code, or â€œimprove UXâ€.

Any deviation from scope is a failure.

â¸»

OBJECTIVE (NON-NEGOTIABLE)

Implement Paystack payment processing for orders such that:
	1.	Buyers can pay for an order
	2.	Payments are verifiable, idempotent, and auditable
	3.	Orders and inventory remain correct even on failure
	4.	Admin can inspect payment state
	5.	NO vendor payouts yet

â¸»

SCOPE â€” YOU MAY IMPLEMENT ONLY THESE

1ï¸âƒ£ Payment Initialization
	â€¢	Create Paystack payment with:
	â€¢	email
	â€¢	amount (kobo)
	â€¢	currency = GHS
	â€¢	reference = system-generated, unique, immutable
	â€¢	Reference must be stored on order before redirect
	â€¢	Order status transitions:
	â€¢	pending â†’ payment_pending

2ï¸âƒ£ Payment Verification (SERVER ONLY)
	â€¢	Verify payment only via Paystack API
	â€¢	Never trust client success
	â€¢	On verification success:
	â€¢	Mark order paid
	â€¢	Lock totals
	â€¢	Decrease inventory
	â€¢	On verification failure:
	â€¢	Mark order payment_failed
	â€¢	Inventory must remain unchanged

3ï¸âƒ£ Webhooks (MANDATORY)
	â€¢	Implement Paystack webhook handler
	â€¢	Verify signature using Paystack secret
	â€¢	Handle these events ONLY:
	â€¢	charge.success
	â€¢	charge.failed
	â€¢	Webhook must be:
	â€¢	Idempotent (safe to replay)
	â€¢	Ignoring duplicate events
	â€¢	Store webhook payloads for audit

4ï¸âƒ£ Idempotency Rules (STRICT)
	â€¢	Same reference must never:
	â€¢	Charge twice
	â€¢	Reduce inventory twice
	â€¢	Change order state twice
	â€¢	Replayed webhooks must be no-ops

5ï¸âƒ£ Retry Payment
	â€¢	Buyer may retry payment for:
	â€¢	pending
	â€¢	payment_failed
	â€¢	Retry must reuse:
	â€¢	Same order
	â€¢	New Paystack reference
	â€¢	Old references are permanently invalidated

6ï¸âƒ£ Admin Visibility (READ-ONLY)
	â€¢	Admin can see:
	â€¢	Order ID
	â€¢	Payment reference
	â€¢	Payment status
	â€¢	Verification timestamp
	â€¢	Admin CANNOT edit payment state in Phase 3A

â¸»

EXPLICITLY FORBIDDEN (FAILURE IF TOUCHED)

ðŸš« Vendor payouts
ðŸš« Wallets
ðŸš« Escrow logic
ðŸš« Refund automation
ðŸš« Partial payments
ðŸš« Multi-currency
ðŸš« Messaging
ðŸš« Promotions logic
ðŸš« UX redesign
ðŸš« Schema changes unrelated to payments

If it is not listed in Scope, DO NOT TOUCH IT.

â¸»

DATA & STATE RULES (MANDATORY)

Order States (LOCKED)
	â€¢	pending
	â€¢	payment_pending
	â€¢	paid
	â€¢	payment_failed
	â€¢	cancelled (manual only, not by payment)

No new states allowed.

Inventory Rules
	â€¢	Inventory decreases ONLY AFTER payment is verified
	â€¢	Inventory must never change on:
	â€¢	init
	â€¢	redirect
	â€¢	webhook replay
	â€¢	failed payments

â¸»

ERROR HANDLING (STRICT)
	â€¢	No throw new Error() for expected cases
	â€¢	All payment failures must:
	â€¢	Log server-side
	â€¢	Return safe user message
	â€¢	Never expose Paystack errors to client

â¸»

TESTING â€” REQUIRED (DO NOT SKIP)

You MUST manually test using these accounts:

Buyer

buy@kiosk.com.gh
Password: 123asdqwe

Vendor

ven@kiosk.com.gh
Password: 123asdqwe

Admin

the3rdukem@gmail.com
Password: 123asdqweX$

Test Cases (ALL REQUIRED)

âœ” Successful payment
âœ” Failed payment
âœ” Webhook replay
âœ” Refresh after redirect
âœ” Retry payment
âœ” Inventory correctness
âœ” Duplicate webhook delivery

â¸»

DELIVERY REQUIREMENTS

You must report back with:
	1.	Exact files changed
	2.	Order lifecycle diagram
	3.	Webhook idempotency explanation
	4.	List of Paystack API calls used
	5.	Explicit confirmation that no forbidden scope was touched

If any part is uncertain â€” STOP and report, do not guess.

â¸»

SUCCESS CRITERIA

Phase 3A is successful only if:
	â€¢	Payments are correct
	â€¢	Inventory is never corrupted
	â€¢	Webhooks are safe
	â€¢	Admin can audit
	â€¢	No scope creep occurred

â¸»

âš ï¸ FINAL WARNING

Do not â€œhelpfullyâ€ add features.
Do not refactor unrelated code.
Do not improve UX.

Correct > Clever
