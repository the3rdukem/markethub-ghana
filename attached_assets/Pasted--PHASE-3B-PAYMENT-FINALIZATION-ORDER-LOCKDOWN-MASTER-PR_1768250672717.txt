â¸»

ğŸ”´ PHASE 3B â€” PAYMENT FINALIZATION & ORDER LOCKDOWN

MASTER PROMPT (AUDIT-FIRST, ZERO REGRESSION, ZERO FEATURE CREEP)

ğŸš¨ READ THIS FIRST â€” NON-NEGOTIABLE

You MUST audit existing implementation before writing or changing any code.
If something already exists and works, DO NOT rewrite it, refactor it, or â€œimproveâ€ it.

Your job is to:
	1.	Verify what already exists
	2.	List what is missing
	3.	Implement ONLY the missing pieces
	4.	Prove correctness with concrete tests

If you re-implement existing working logic, the task is considered FAILED.

â¸»

STEP 1 â€” AUDIT (MANDATORY, NO CODE YET)

Inspect the current codebase and explicitly confirm whether the following already exist:

A. Payment & Webhook Handling
	â€¢	Paystack webhook endpoint exists
	â€¢	Webhook idempotency guard exists (paid orders not reprocessed)
	â€¢	Duplicate webhooks safely ignored
	â€¢	Failed payment restores inventory only once

B. Order State Handling
	â€¢	Order statuses already defined
	â€¢	Client cannot mark order as paid
	â€¢	Payment success only applied server-side (webhook)

C. Retry Payment Flow
	â€¢	Buyer can retry failed/pending payments
	â€¢	New payment reference generated server-side
	â€¢	Already-paid orders rejected on retry

D. Inventory Reservation
	â€¢	Inventory is reserved at checkout
	â€¢	Inventory is finalized on payment success
	â€¢	Inventory is released on payment failure

ğŸ“Œ Produce a short audit report listing:
	â€¢	âœ… Already implemented (do nothing)
	â€¢	âŒ Missing or incomplete (to be fixed)

DO NOT proceed without this list.

â¸»

STEP 2 â€” IMPLEMENT ONLY WHAT IS MISSING

Based on the audit, implement ONLY missing or incomplete items from the list below.

REQUIRED PHASE 3B BEHAVIOR (IMPLEMENT ONLY IF MISSING)

1ï¸âƒ£ Order State Lockdown
	â€¢	Enforce strict state transitions:
	â€¢	payment_pending â†’ paid ONLY via webhook
	â€¢	Paid orders become immutable (no edits, no re-pricing)

2ï¸âƒ£ Final Price Snapshot (If Missing)
	â€¢	At payment initialization, snapshot and persist:
	â€¢	unit price
	â€¢	sale discount
	â€¢	coupon discount
	â€¢	tax
	â€¢	shipping
	â€¢	Never recompute price after payment starts

3ï¸âƒ£ Inventory Finalization (If Incomplete)
	â€¢	Payment success â†’ decrement inventory (exactly once)
	â€¢	Payment failure â†’ release reservation (exactly once)
	â€¢	Use database-level idempotency (not just in-memory checks)

4ï¸âƒ£ Vendor Order Visibility Rule
	â€¢	Vendors must ONLY see paid orders
	â€¢	No pending/failed payments in vendor dashboard

5ï¸âƒ£ Admin Guarantees
	â€¢	Admin cannot mark orders as paid manually
	â€¢	Admin sees:
	â€¢	payment provider
	â€¢	reference
	â€¢	status
	â€¢	timestamp

â¸»

STEP 3 â€” HARD RULES (NO EXCEPTIONS)

ğŸš« Do NOT introduce:
	â€¢	refunds
	â€¢	payouts
	â€¢	wallets
	â€¢	partial payments
	â€¢	split payments
	â€¢	schema changes unless unavoidable

ğŸš« Do NOT refactor existing working flows
ğŸš« Do NOT change UX unless required to enforce rules
ğŸš« Do NOT touch Phase 4+ features

â¸»

STEP 4 â€” VERIFICATION (MANDATORY)

Provide manual test steps using these credentials:

Admin
	â€¢	the3rdukem@gmail.com / 123asdqweX$

Vendor
	â€¢	ven@kiosk.com.gh / 123asdqwe

Buyer
	â€¢	buy@kiosk.com.gh / 123asdqwe

Must Prove ALL of the Following:

âœ… Payment success webhook marks order paid once
âœ… Duplicate webhook causes no mutation
âœ… Inventory decrements exactly once
âœ… Failed payment restores inventory
âœ… Retry payment works but cannot double-charge
âœ… Vendor sees only paid orders
âœ… Buyer cannot modify paid order

If any item fails â†’ report FAILURE, not â€œmostly worksâ€.

â¸»

STEP 5 â€” FINAL REPORT FORMAT (STRICT)

Your final response MUST be structured as:
	1.	Audit Results (What already existed)
	2.	Gaps Found
	3.	Changes Made (File-level)
	4.	Manual Test Results
	5.	Explicit Confirmation: â€œPhase 3B Completeâ€ or â€œPhase 3B Failedâ€

â¸»

ğŸ”’ SUCCESS CRITERIA

If Phase 3B passes, we proceed to:
Phase 3C â€” Refunds & Vendor Payout Readiness

If not, we stop and fix only the failing item.
