
üî• PROMOTIONS CORRECTIONS MASTER PROMPT (MANDATORY VERIFICATION)

CONTEXT

We already have a database-backed Promotions & Discounts system (Coupons + Sales) with persistence.
However, there are critical correctness bugs that must be fixed before payments, orders, or external APIs can be safely enabled.

This prompt is NOT about adding new features.
It is about fixing broken logic to industry-standard marketplace behavior.

‚∏ª

üö® CRITICAL RULES (DO NOT IGNORE)
	1.	Do NOT overwrite product prices in the database
	2.	Do NOT apply vendor coupons to other vendors‚Äô products
	3.	Do NOT rely on Zustand/localStorage for pricing
	4.	All pricing must be computed dynamically
	5.	Every fix must be verified using real test accounts

‚∏ª

SECTION 1 ‚Äî FIX SALES: MULTI-PRODUCT SUPPORT

CURRENT PROBLEM
	‚Ä¢	A sale can only be applied to one product
	‚Ä¢	This blocks real vendor use cases

REQUIRED BEHAVIOR
	‚Ä¢	A single sale must support multiple products
	‚Ä¢	Vendors must be able to select many of their own products

REQUIRED IMPLEMENTATION
	‚Ä¢	Introduce a join table:

sale_products (
  id,
  sale_id,
  product_id
)

	‚Ä¢	Remove any single product_id constraint from sales
	‚Ä¢	Update sale creation UI:
	‚Ä¢	Multi-select product picker
	‚Ä¢	Only vendor-owned products are selectable
	‚Ä¢	Update APIs:
	‚Ä¢	Create sale ‚Üí attach multiple products
	‚Ä¢	Fetch active sales ‚Üí resolve all linked products

‚∏ª

SECTION 2 ‚Äî FIX COUPON SCOPE (SEVERITY 1 BUG)

CURRENT PROBLEM
	‚Ä¢	Coupons discount products from other vendors
	‚Ä¢	This is unacceptable and blocks checkout entirely

REQUIRED BEHAVIOR (NON-NEGOTIABLE)
	‚Ä¢	Coupons apply ONLY to:
	‚Ä¢	Products sold by the vendor who created the coupon
	‚Ä¢	Coupons must NOT affect:
	‚Ä¢	Other vendors‚Äô items
	‚Ä¢	Cart subtotal globally

REQUIRED IMPLEMENTATION

Coupon Validation API
When validating a coupon:
	1.	Resolve coupon ‚Üí get vendor_id
	2.	Identify cart line items belonging to that vendor
	3.	Return line-item scoped discount, NOT cart-level discount

Checkout Price Calculation
	‚Ä¢	Apply coupon discount per eligible cart item
	‚Ä¢	Other cart items must remain unchanged

üìå Example (MANDATORY BEHAVIOR):

Cart:
	‚Ä¢	Vendor A product ‚Üí $100
	‚Ä¢	Vendor B product ‚Üí $50

Coupon from Vendor A (10%)

Correct result:
	‚Ä¢	Vendor A item ‚Üí $90
	‚Ä¢	Vendor B item ‚Üí $50
	‚Ä¢	Total ‚Üí $140

‚∏ª

SECTION 3 ‚Äî FIX SALES PRICE APPLICATION (DISPLAY & CART)

CURRENT PROBLEM
	‚Ä¢	Sales exist but do not affect displayed prices
	‚Ä¢	Product pages, search results, and cart ignore sales

REQUIRED BEHAVIOR

Active sales must affect:
	‚Ä¢	Homepage product cards
	‚Ä¢	Marketplace search results
	‚Ä¢	Product detail pages
	‚Ä¢	Cart
	‚Ä¢	Checkout
	‚Ä¢	Order snapshots

REQUIRED PRICING HIERARCHY

Price priority must be:
	1.	Active Sale (time-based, computed)
	2.	Compare / promotional price (manual)
	3.	Base price

REQUIRED IMPLEMENTATION
	‚Ä¢	Introduce computed field:

effective_price

	‚Ä¢	Never persist discounted price to DB
	‚Ä¢	Resolve active sale by:
	‚Ä¢	product_id
	‚Ä¢	current date within sale range
	‚Ä¢	Compute discount dynamically

‚∏ª

SECTION 4 ‚Äî ALIGN UI WITH PRICING LOGIC

REQUIRED UI FIXES
	‚Ä¢	Product cards must show:
	‚Ä¢	Discounted price
	‚Ä¢	Original price (struck-through)
	‚Ä¢	Sale badge (e.g. ‚Äú20% OFF‚Äù)
	‚Ä¢	Product page must show:
	‚Ä¢	Sale price
	‚Ä¢	Original price
	‚Ä¢	Sale validity (optional but preferred)
	‚Ä¢	Cart must:
	‚Ä¢	Show discounted line item price
	‚Ä¢	Clearly indicate coupon or sale applied

‚∏ª

SECTION 5 ‚Äî ADMIN ROLE (CLARIFICATION)

DO NOT IMPLEMENT
	‚Ä¢	Admin editing vendor coupons
	‚Ä¢	Admin creating vendor sales

ALLOWED / OPTIONAL
	‚Ä¢	Admin can:
	‚Ä¢	Disable a vendor promotion
	‚Ä¢	View promotions for moderation
	‚Ä¢	Admin promotions (platform-wide) are OUT OF SCOPE for this prompt

‚∏ª

SECTION 6 ‚Äî REMOVE WRONG DEPENDENCIES
	‚Ä¢	Do NOT use Zustand or localStorage for:
	‚Ä¢	Promotions
	‚Ä¢	Sales
	‚Ä¢	Pricing
	‚Ä¢	All pricing must come from API ‚Üí DB ‚Üí computed response

‚∏ª

SECTION 7 ‚Äî MANDATORY TESTING (USE THESE CREDENTIALS)

Buyer

Email: buy@kiosk.com.gh
Password: 123asdqwe

Vendor

Email: ven@kiosk.com.gh
Password: 123asdqwe

Admin

Email: the3rdukem@gmail.com
Password: 123asdqweX$

REQUIRED TEST CASES (MUST CONFIRM ALL)
	1.	Vendor creates a sale with multiple products
	2.	Sale prices reflect on:
	‚Ä¢	Homepage
	‚Ä¢	Product page
	‚Ä¢	Cart
	3.	Vendor creates coupon
	4.	Buyer adds products from two different vendors
	5.	Coupon discounts only vendor‚Äôs own products
	6.	Coupon survives logout/login
	7.	Cart totals are correct
	8.	No console errors
	9.	No stale state after refresh

‚∏ª

SECTION 8 ‚Äî REPORTING RULES

The agent MUST:
	‚Ä¢	Explicitly state what was broken
	‚Ä¢	Explain why it was broken
	‚Ä¢	Show how it was fixed
	‚Ä¢	Confirm each test case passed
	‚Ä¢	NOT claim success without verification

üö´ Statements like:

‚ÄúThis should now work‚Äù
are NOT acceptable

‚∏ª

SUCCESS DEFINITION

‚úÖ Promotions are safe
‚úÖ Pricing is correct everywhere
‚úÖ Coupons cannot corrupt orders
‚úÖ Sales behave like a real marketplace
‚úÖ Ready for payments & checkout flow

‚∏ª