# Sabi Market V3

## Overview
MarketHub is a secure marketplace platform for Ghana, designed to connect buyers with verified vendors. It features Mobile Money payments, robust buyer protection, and a comprehensive admin verification system. The platform aims to provide a reliable and safe e-commerce experience, leveraging modern web technologies for scalability and performance.

## User Preferences
I want iterative development.
I want to be asked before you make any major changes.
I prefer detailed explanations for complex solutions.
Do not make changes to files in the `src/lib/` directory unless explicitly instructed.
I prefer clear and concise communication.

## System Architecture
The platform is built with Next.js 15, Tailwind CSS for styling, and `shadcn/ui` for UI components, ensuring a modern and responsive user experience. PostgreSQL is used as the primary database, managed by Replit, with a focus on connection pooling and async data access.

**Key Technical Implementations:**
- **Database**: PostgreSQL with a dedicated Data Access Layer (DAL) using `pg` for connection pooling and async operations. Schema includes proper constraints (UNIQUE, NOT NULL, CHECK, FOREIGN KEY).
- **Authentication**: Server-authoritative session management via a single `session_token` httpOnly cookie. Strong password validation (8+ chars, 1 uppercase, 1 lowercase, 1 number). Email uniqueness allows same email for buyer+vendor accounts, but admin emails are globally unique. Login provides differentiated error codes for debugging while maintaining secure user-facing messages.
- **Input Validation**: Comprehensive server-side validation across all API endpoints with structured error responses including code, message, details, field, and validationErrors array. Client-side password strength indicator on registration form provides real-time feedback. Phase 1.1B added: email garbage detection, name/address content safety filtering, Ghana phone format + global uniqueness check, field-specific error attribution, and single error presentation (inline errors only, no duplicate toasts). Phase 1.1C added: full product form validation parity (name, description, color, brand, tags with profanity/garbage detection), field-specific errors with auto-scroll/focus on failing fields. Phase 1.1D added: form field registration parity (id/name/data-field on all inputs including category Select), complete fieldMap coverage (name, description, category, price, comparePrice, quantity, sku, barcode, color, brand, tags), server-side numeric normalization (quantity→0, comparePrice→null when empty), API response normalization (null quantity/price→0), Radix Select safety (value||"" pattern), and database repair script (fixes NULL quantities on init). **Phase 1.2 (Product Form Architecture Lockdown) - COMPLETE**: Unified React Hook Form controller with Zod schema validation. Key files: `src/lib/forms/product.ts` (schema + transform utilities), `src/lib/forms/useProductForm.ts` (hook wrapping RHF). Sentinel pattern: `UNSET_VALUE = "__unset__"` for Select field defaults to prevent Radix crashes. Server rejects sentinel values ONLY when publishing (status='active'), allowing drafts to save with minimal validation. Condition is a dedicated top-level required field (not in dynamic categoryAttributes). transformFormToApiPayload filters __unset__ values from optional categoryAttributes before submission. transformApiToFormValues handles legacy condition data from categoryAttributes. Required fields: name (always), category/condition/price>0/quantity>=0 (when publishing). Validation split: Draft = name only, Publish = full Zod schema validation. Error UX: inline red borders + auto-scroll/focus on first error field. **Phase 1.2 Recovery (Jan 2026)**: Dynamic category attribute architecture fully implemented across vendor create/edit and admin edit forms. Per-field Controller registration using `name={fieldPath as any}` for dynamic nested paths. Reconciliation effect: triggers on category OR schema change, gated on categoriesLoading, preserves existing values while removing stale keys and seeding defaults for new keys. DynamicAttributeField component renders all field types with proper data-field attributes for scroll-to-error. scrollToFirstError flattens nested categoryAttributes errors. Categories fetched dynamically from /api/categories with memoized currentCategoryFields. **Admin Select Sentinel Pattern (Jan 2026)**: Admin product/user management dialogs (src/components/admin/product-management.tsx, user-management.tsx) use `ADMIN_UNSET = "__unset__"` for uninitialized Select fields. Pattern: store ADMIN_UNSET in React state, pass `undefined` to Select component when value is ADMIN_UNSET (e.g., `value={state.field === ADMIN_UNSET ? undefined : state.field}`), sanitize payloads before API calls by filtering/converting ADMIN_UNSET values. This prevents Radix Select crashes since undefined triggers placeholder display instead of searching for non-existent option.
- **Governance System**: Comprehensive system for vendor and product management, including vendor verification, product gating, category management with dynamic form schema, and detailed audit logging for critical administrative actions. **Phase 1 Stability Fix (Jan 2026)**: Radix Select crash prevention for Admin Products page. Database sanitization on startup converts empty category strings to NULL. API endpoints normalize category to null (never empty string). Admin UI hardened with filter in categories useMemo to exclude null/empty/whitespace values. Product store type updated to allow `category: string | null`. Select guard utility (`src/lib/utils/select-guard.ts`) provides `filterSelectValues()`, `assertSelectValue()`, and `getUniqueSelectValues()` for regression protection.
- **Product Contract Unification (Jan 2026)**: Canonical product data contract at `src/lib/contracts/product.contract.ts`. Key components: `ProductLike` interface (accepts both snake_case DB and camelCase API keys), `normalizeProductForApi()` (consistent shape conversion), `normalizeCondition()` (coerces legacy capitalized values to canonical lowercase). **CONDITION REFACTOR (Jan 2026)**: Condition is NOW CATEGORY-SPECIFIC ONLY - it lives ONLY in categoryAttributes when a category's formSchema defines a condition field. NOT a top-level database column or API field. DAL createProduct/updateProduct merge condition into categoryAttributes. Database migration copies legacy condition column data into categoryAttributes. Admin create dialog includes SKU/barcode fields. CONDITION_VALUES: ["new", "like_new", "good", "fair", "poor"]. Added `created_by` column to users table for admin creator tracking.
- **Admin Deletion Permissions (Jan 2026)**: Master admin can delete ANY admin account (including legacy admins with NULL created_by). The `created_by` field tracks which master_admin created each admin. Regular admins cannot delete other admins. Self-deletion is blocked for all users.
- **Admin Product Edit Dialog (Jan 2026)**: Product editing uses inline dialog instead of page navigation. Dialog fetches fresh product data from `/api/products/:id` before populating form. Supports all fields including dynamic category attributes. Price/quantity converted to numbers before API submission.
- **Validation Relaxation (Jan 2026)**: `simpleOptionalTextField()` created for color/brand fields - bypasses content safety validation to allow multi-word color names like "Midnight Blue". Description minimum changed from 10 chars to 1 char (required for publish, optional for draft). Social media handle regex patterns (instagram, facebook, twitter) fixed to use word boundaries, preventing false positives like "Midnight" matching the "ig" pattern.
- **Phone Uniqueness Fix (Jan 2026)**: `isPhoneInUse()` and `getUserByPhone()` in DAL now check all possible phone format variants (local `0244...` and E.164 `+233244...`) to handle legacy data inconsistencies. Uses `getPhoneVariants()` helper to generate all matching formats for a single phone number, ensuring duplicate phones are detected regardless of stored format.
- **Cart System**: Secure cart ownership model with guest and user carts, including guest-to-user cart merging on authentication and persistence for user carts.
- **Reviews System**: Full-fledged database-backed review system allowing buyers to rate products, vendors to reply, and administrators to moderate content.
- **Promotions System**: Database-backed coupons and sales management. Vendors create/manage their own promotions via `/vendor/promotions`. Admins view all promotions read-only at `/admin/promotions`. Coupons are validated at checkout with vendor scoping enforcement (coupons only apply to vendor's products in cart using `eligibleSubtotal`). Sales support multiple products via `sale_products` join table with discount type (percentage/fixed) and date ranges. Active sales are displayed across all product views (homepage, search, product detail) with animated discount badges and struck-through original prices. Products API returns `effectivePrice` computed from active sales and `activeSale` metadata. Cart uses effective prices when adding products with active sales.
- **Phase 2 Order Pipeline (Jan 2026)**: Server-side order management via PostgreSQL. Key components:
  - **Order Schema**: `orders` table with buyer info, totals (subtotal, discount_total, shipping_fee, tax, total), status (pending_payment → fulfilled/cancelled), payment_status, shipping_address JSON, coupon_code. `order_items` table tracks per-item fulfillment with vendor_id, quantity, unit_price, applied_discount, final_price, fulfillment_status.
  - **Checkout Flow**: POST `/api/orders` validates cart, creates order with order_items, decrements product inventory via `reduceInventory()`, clears cart, creates audit log. Orders start with status='pending_payment'.
  - **Vendor Fulfillment**: PATCH `/api/orders/:id` with `{action: 'fulfill', itemId}` marks vendor's item as fulfilled. When ALL items in order are fulfilled, order status auto-updates to 'fulfilled'.
  - **Admin Cancellation**: DELETE `/api/orders/:id` cancels order (only if not already fulfilled/cancelled), restores inventory via `cancelOrderWithInventoryRestore()`, creates audit log.
  - **UI Pages**: Buyer orders list (`/buyer/orders`), buyer order detail (`/buyer/orders/:id`), vendor orders with item-level fulfillment (`/vendor/orders`), admin orders with cancellation (`/admin/orders`). Order success page (`/order-success`) fetches real order data.
  - **Status Flow**: pending_payment → (vendor fulfills all items) → fulfilled; OR pending_payment → (admin cancels) → cancelled (inventory restored).
  - **Order Data Structure (Jan 2026)**: API returns both `items` (legacy JSON) and `orderItems` (from order_items table with database IDs). UI pages prefer `orderItems` for operations requiring item IDs (vendor fulfillment).
  - **Vendor Fulfill Fix (Jan 2026)**: Changed vendor orders page to use `order.orderItems` (with proper database IDs) instead of `order.items` (legacy JSON without IDs) for fulfillment requests. Per-item loading state (`fulfillingItemId`) instead of shared `isFulfilling`.
  - **Order Data Normalization (Jan 2026)**: API endpoints normalize legacy `items` JSON to include `unitPrice` and `finalPrice` fields for consistency with new `orderItems` table structure. All UI pages use `getOrderItems(order)` helper that prefers `orderItems` when available, falling back to legacy `items`. Price calculation: `item.finalPrice != null ? item.finalPrice : (item.unitPrice * item.quantity)`. Buyer dashboard uses local React state instead of Zustand store for orders. 30-second polling intervals added to buyer/vendor/admin order pages for real-time status synchronization.
- **Auth Redirect Security (Jan 2026)**: Login/register pages respect `?redirect` query param for post-auth navigation. Open redirect vulnerability prevented via `getSafeRedirectUrl()` utility (`src/lib/utils/safe-redirect.ts`) which validates URLs to allow only same-origin relative paths (starting with "/" but not "//"). All auth pages wrapped in Suspense for useSearchParams.
- **Buyer Orders Persistence Fix (Jan 2026)**: Added `user?.id` as dependency to buyer orders fetch effect so orders refetch when user identity changes (login/logout cycles). Buyer dashboard now syncs orders from API to Zustand store on load, ensuring orders persist correctly across sessions.
- **Admin Dropdown Fix (Jan 2026)**: Changed admin orders page dropdown menu items from `onClick` to `onSelect` with `e.preventDefault()` to fix Radix UI event handling issue where dialogs wouldn't open. Button changed to `size="icon"` with explicit dimensions (`h-8 w-8 min-w-[2rem] flex-shrink-0`) and wrapped in flex container (`<div className="flex justify-end">`) to prevent table layout collapse. Same fix applied to user-management.tsx for admin user actions.
- **Cart Merge on Login (Jan 2026)**: Created awaitable `mergeCartAfterAuth()` function in auth-store.ts. Login page awaits cart merge before redirecting, ensuring guest cart items persist through checkout sign-in flow.
- **API-First Approach**: All major data interactions, including product listings, search, vendor analytics, and administrative functions, are handled via dedicated API endpoints, moving away from client-side state management for data consistency.
- **UI/UX**: Utilizes `shadcn/ui` for consistent and accessible components. The platform is designed to be intuitive for buyers, vendors, and administrators, with distinct dashboards for each user type.

## External Dependencies
- **Paystack**: For Mobile Money payment processing.
- **PostgreSQL**: Managed database service.
- **Image Storage**: Provider-agnostic storage abstraction for handling image uploads (currently local filesystem with cloud migration path).